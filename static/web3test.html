<html>
  <head>
    <script src="js/web3.min.js"></script>
    <script src="js/ropsten-abi.js"></script>
  </head>
  <body onload="init();">
    <div id="myAddr"></div>
    <div id="fId"></div>

    <script type="text/javascript">
      var b2s = function(bytes) {
        var s = "";
        for(var i=2; i<bytes.length; i+=2) {
          var num = parseInt(bytes.substring(i, i+2), 16);
          if (num == 0) break;
          var char = String.fromCharCode(num);
          s += char;
        }
        return s;
      };

      var foundationAbi;
      var fContract;
      var fAddress;
      var debtContract;

      var myAddress;
      var txHash;

      var printTxStatus = function() {
        setInterval(function() {
          web3.eth.getTransaction(txHash, function(err, result) {
            if ( err ) {
              console.log(err);
            }
            else {
              console.log(result);
            }
          });
        }, 3000);
      };

      var addAddr = function(addr) {
        var data = fContract.addPendingUnification.getData(addr);
        sendFoundationTx(data);
        printTxStatus();
      };

      var getNetwork = function() {
        web3.version.getNetwork(function(err, netId) {
          if ( typeof err == "undefined" )
            console.log(netId);
          else
            console.log(err);
        });
      };

      var checkId = function(a, numTries) {
        console.log("about to check id");
        var div = document.getElementById("fId");
//        debtContract.getMyFoundationId( function(e,r) {
        fContract.resolveToName(a, function(e, r) {
          if (!e) {
            console.log("successful chek");
            console.log(r.valueOf());
            div.innerHTML = "FoundationID: " + b2s(r.valueOf());
          }
          else {
            if (numTries > 0) {
              console.log("numTries was:  " + numTries);
              checkId(a, numTries - 1);
            }
            else
              console.log("timed out after some retries");
          }
        });
      };

      var init = function() {
        debtContract = web3.eth.contract(debtConfig.abi).at(debtConfig.address);
        fContract = web3.eth.contract(foundationConfig.abi).at(foundationConfig.address);
        var d = document.getElementById("myAddr");
        setTimeout(function() {
          myAddress = web3.eth.accounts[0];
          checkId(myAddress, 4);
          d.innerHTML = myAddress;
//          addAddr("0x1A9a7bFA6C2CC628573E1514AE13947d83df9C80");
        }, 2000);
      };

      var sendFoundationTx = function(data) {
        web3.eth.sendTransaction(
          {to: fAddress, from: myAddress, data: data},
          function(err, result) {
            if ( !err )
              txHash = result;
          });
      };
    </script>
  </body>
</html>
