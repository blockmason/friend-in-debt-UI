// Generated by purs version 0.11.5
"use strict";
var Control_Applicative = require("../Control.Applicative");
var Control_Bind = require("../Control.Bind");
var Control_Monad_Aff = require("../Control.Monad.Aff");
var Control_Monad_Aff_Bus = require("../Control.Monad.Aff.Bus");
var Control_Monad_Aff_Class = require("../Control.Monad.Aff.Class");
var Control_Monad_Eff = require("../Control.Monad.Eff");
var Control_Monad_Eff_Class = require("../Control.Monad.Eff.Class");
var Control_Monad_Eff_Console = require("../Control.Monad.Eff.Console");
var Control_Monad_Eff_Timer = require("../Control.Monad.Eff.Timer");
var Control_Monad_State_Class = require("../Control.Monad.State.Class");
var Data_Either = require("../Data.Either");
var Data_Either_Nested = require("../Data.Either.Nested");
var Data_Eq = require("../Data.Eq");
var Data_Function = require("../Data.Function");
var Data_Functor = require("../Data.Functor");
var Data_Functor_Coproduct_Nested = require("../Data.Functor.Coproduct.Nested");
var Data_HeytingAlgebra = require("../Data.HeytingAlgebra");
var Data_Int = require("../Data.Int");
var Data_Maybe = require("../Data.Maybe");
var Data_Ord = require("../Data.Ord");
var Data_Semigroup = require("../Data.Semigroup");
var Data_Time_Duration = require("../Data.Time.Duration");
var Data_Unit = require("../Data.Unit");
var Data_Void = require("../Data.Void");
var Debts = require("../Debts");
var FriendInDebt_Prelude = require("../FriendInDebt.Prelude");
var Halogen = require("../Halogen");
var Halogen_Component = require("../Halogen.Component");
var Halogen_Component_ChildPath = require("../Halogen.Component.ChildPath");
var Halogen_Component_Utils = require("../Halogen.Component.Utils");
var Halogen_HTML = require("../Halogen.HTML");
var Halogen_HTML_Core = require("../Halogen.HTML.Core");
var Halogen_HTML_Elements = require("../Halogen.HTML.Elements");
var Halogen_HTML_Events = require("../Halogen.HTML.Events");
var Halogen_HTML_Properties = require("../Halogen.HTML.Properties");
var Halogen_Query = require("../Halogen.Query");
var Halogen_Query_EventSource = require("../Halogen.Query.EventSource");
var Halogen_Query_HalogenM = require("../Halogen.Query.HalogenM");
var Network_Eth_Metamask = require("../Network.Eth.Metamask");
var Types = require("../Types");
var Init = (function () {
    function Init(value0) {
        this.value0 = value0;
    };
    Init.create = function (value0) {
        return new Init(value0);
    };
    return Init;
})();
var HandleMsg = (function () {
    function HandleMsg(value0, value1) {
        this.value0 = value0;
        this.value1 = value1;
    };
    HandleMsg.create = function (value0) {
        return function (value1) {
            return new HandleMsg(value0, value1);
        };
    };
    return HandleMsg;
})();
var RefreshMetamask = (function () {
    function RefreshMetamask(value0) {
        this.value0 = value0;
    };
    RefreshMetamask.create = function (value0) {
        return new RefreshMetamask(value0);
    };
    return RefreshMetamask;
})();
var SetScreen = (function () {
    function SetScreen(value0, value1) {
        this.value0 = value0;
        this.value1 = value1;
    };
    SetScreen.create = function (value0) {
        return function (value1) {
            return new SetScreen(value0, value1);
        };
    };
    return SetScreen;
})();
var startCheckInterval = function (dictApplicative) {
    return function (dictBind) {
        return function (dictMonadEff) {
            return function (maybeBus) {
                return function (ms) {
                    var effToRun = function (bus) {
                        return function __do() {
                            var v = Control_Monad_Aff.launchAff(Control_Monad_Aff_Bus.write(Types.CheckMetamask.value)(bus))();
                            return Data_Unit.unit;
                        };
                    };
                    if (maybeBus instanceof Data_Maybe.Nothing) {
                        return Control_Applicative.pure(dictApplicative)(Data_Unit.unit);
                    };
                    if (maybeBus instanceof Data_Maybe.Just) {
                        return Control_Bind.bind(dictBind)(Control_Monad_Eff_Class.liftEff(dictMonadEff)(Control_Monad_Eff_Timer.setInterval(ms)(effToRun(maybeBus.value0))))(function (v) {
                            return Control_Applicative.pure(dictApplicative)(Data_Unit.unit);
                        });
                    };
                    throw new Error("Failed pattern match at Container line 149, column 3 - line 153, column 16: " + [ maybeBus.constructor.name ]);
                };
            };
        };
    };
};
var refreshMetamask = Control_Bind.bind(Halogen_Query_HalogenM.bindHalogenM)(Data_Functor.map(Halogen_Query_HalogenM.functorHalogenM)(Network_Eth_Metamask.loggedIn)(Control_Monad_Eff_Class.liftEff(Halogen_Query_HalogenM.monadEffHalogenM(Control_Monad_Aff.monadEffAff))(Network_Eth_Metamask.checkStatus)))(function (v) {
    if (v) {
        return Control_Bind.bind(Halogen_Query_HalogenM.bindHalogenM)(Halogen_Query["query'"](Data_Either.eqEither(Data_Eq.eqUnit)(Data_Eq.eqVoid))(Halogen_Component_ChildPath.cp1)(Data_Unit.unit)(new Debts.RefreshDebts(Data_Unit.unit)))(function (v1) {
            return Control_Bind.bind(Halogen_Query_HalogenM.bindHalogenM)(Data_Functor.map(Halogen_Query_HalogenM.functorHalogenM)(Network_Eth_Metamask.loggedIn)(Control_Monad_Eff_Class.liftEff(Halogen_Query_HalogenM.monadEffHalogenM(Control_Monad_Aff.monadEffAff))(Network_Eth_Metamask.checkStatus)))(function (v2) {
                return Control_Monad_State_Class.modify(Halogen_Query_HalogenM.monadStateHalogenM)(function (v3) {
                    var $24 = {};
                    for (var $25 in v3) {
                        if ({}.hasOwnProperty.call(v3, $25)) {
                            $24[$25] = v3[$25];
                        };
                    };
                    $24.loggedIn = v2;
                    return $24;
                });
            });
        });
    };
    return Control_Monad_State_Class.modify(Halogen_Query_HalogenM.monadStateHalogenM)(function (v1) {
        var $27 = {};
        for (var $28 in v1) {
            if ({}.hasOwnProperty.call(v1, $28)) {
                $27[$28] = v1[$28];
            };
        };
        $27.loggedIn = v;
        return $27;
    });
});
var promptMetamask = function (loggedIn) {
    return Halogen_HTML_Elements.div([ Halogen_HTML_Properties.id_("metamaskOverlay"), (function () {
        if (loggedIn) {
            return Halogen_HTML_Properties.class_("inActive");
        };
        return Halogen_HTML_Properties.class_("active");
    })() ])([ Halogen_HTML_Elements.div_([ Halogen_HTML_Elements.h6_([ Halogen_HTML_Core.text("Not logged in to Metamask.") ]), Halogen_HTML_Elements.button([ Halogen_HTML_Events.onClick(Halogen_HTML_Events.input_(RefreshMetamask.create)), Halogen_HTML_Properties.class_("btn-info") ])([ Halogen_HTML_Core.text("Retry") ]) ]) ]);
};
var loadingOverlay = function (loading) {
    return Halogen_HTML_Elements.div([ Halogen_HTML_Properties.id_("loadingOverlay"), (function () {
        if (loading) {
            return Halogen_HTML_Properties.class_("active");
        };
        return Halogen_HTML_Properties.class_("inActive");
    })() ])([ Halogen_HTML_Elements.h6_([ Halogen_HTML_Core.text("Loading Metamask...") ]) ]);
};
var checkMetamask = function (loggedIn) {
    return function (mmStatus) {
        var $32 = loggedIn && mmStatus;
        if ($32) {
            return Control_Applicative.pure(Halogen_Query_HalogenM.applicativeHalogenM)(Data_Unit.unit);
        };
        return refreshMetamask;
    };
};
var ui = (function () {
    var render = function (state) {
        return Halogen_HTML_Elements.div([ Halogen_HTML_Properties.id_("container"), Halogen_HTML_Properties.class_(Halogen_HTML_Core.ClassName("container-fluid " + state.currentScreen)) ])([ promptMetamask(state.loggedIn), loadingOverlay(state.loading), Halogen_HTML_Elements.a([ Halogen_HTML_Properties.href("#"), Halogen_HTML_Properties.class_("close-pop-button"), Halogen_HTML_Events.onClick(Halogen_HTML_Events.input_(SetScreen.create("show-debts"))) ])([ Halogen_HTML_Core.text("\u2573") ]), Halogen_HTML_Elements.div([ Halogen_HTML_Properties.id_("header"), Halogen_HTML_Properties.class_("row") ])([ Halogen_HTML_Elements.a([ Halogen_HTML_Properties.href("#"), Halogen_HTML_Properties.class_(Halogen_HTML_Core.ClassName("col-3 " + (function () {
            var $33 = state.currentScreen === "show-friends";
            if ($33) {
                return "active";
            };
            return "";
        })())), Halogen_HTML_Events.onClick(Halogen_HTML_Events.input_(SetScreen.create("show-friends"))) ])([ Halogen_HTML_Core.text("Friend") ]), Halogen_HTML_Elements.a([ Halogen_HTML_Properties.href("#"), Halogen_HTML_Properties.class_(Halogen_HTML_Core.ClassName("col-3 " + (function () {
            var $34 = state.currentScreen === "show-debts";
            if ($34) {
                return "active";
            };
            return "";
        })())), Halogen_HTML_Events.onClick(Halogen_HTML_Events.input_(SetScreen.create("show-debts"))) ])([ Halogen_HTML_Core.text("Debt") ]) ]), Halogen_HTML_Elements.div([ Halogen_HTML_Properties.class_("row"), Halogen_HTML_Properties.id_("container") ])([ Halogen_HTML_Elements.div([ Halogen_HTML_Properties.class_("col") ])([ Halogen_HTML["slot'"](Halogen_Component_ChildPath.cp1)(Data_Unit.unit)(Debts.component)(state.errorBus)(Data_Void.absurd) ]) ]), Halogen_HTML_Elements.div([ Halogen_HTML_Properties.class_("row toolbar") ])([ Halogen_HTML_Elements.a([ Halogen_HTML_Properties.href("#"), Halogen_HTML_Properties.class_("col home"), Halogen_HTML_Events.onClick(Halogen_HTML_Events.input_(SetScreen.create("show-debts"))) ])([ Halogen_HTML_Elements.img([ Halogen_HTML_Properties.src("http://lunarhash.com/assets/img/friends_in_debt_logo.svg") ]), Halogen_HTML_Core.text("Home") ]), Halogen_HTML_Elements.a([ Halogen_HTML_Properties.href("#"), Halogen_HTML_Properties.class_("col create-debt-button"), Halogen_HTML_Events.onClick(Halogen_HTML_Events.input_(SetScreen.create("show-create-debt"))) ])([ Halogen_HTML_Elements.img([ Halogen_HTML_Properties.src("create_debt_icon.svg") ]), Halogen_HTML_Core.text("Create Debt") ]), Halogen_HTML_Elements.a([ Halogen_HTML_Properties.href("#"), Halogen_HTML_Properties.class_("col add-friend-button"), Halogen_HTML_Events.onClick(Halogen_HTML_Events.input_(SetScreen.create("show-add-friend"))) ])([ Halogen_HTML_Elements.img([ Halogen_HTML_Properties.src("connect_friend_icon.svg") ]), Halogen_HTML_Core.text("Add Friend") ]) ]) ]);
    };
    var initialState = {
        loggedIn: true, 
        loading: true, 
        errorBus: Data_Maybe.Nothing.value, 
        currentScreen: "show-debts"
    };
    var $$eval = function (v) {
        if (v instanceof Init) {
            return Control_Bind.bind(Halogen_Query_HalogenM.bindHalogenM)(Control_Monad_Aff_Class.liftAff(Halogen_Query_HalogenM.monadAffHalogenM(Control_Monad_Aff_Class.monadAffAff))(Control_Monad_Aff_Bus.make))(function (v1) {
                return Control_Bind.discard(Control_Bind.discardUnit)(Halogen_Query_HalogenM.bindHalogenM)(Halogen_Query_HalogenM.subscribe(Halogen_Component_Utils.busEventSource(Control_Monad_Aff_Class.monadAffAff)(Data_Function.flip(HandleMsg.create)(Halogen_Query_EventSource.Listening.value))(v1)))(function () {
                    return Control_Bind.discard(Control_Bind.discardUnit)(Halogen_Query_HalogenM.bindHalogenM)(Control_Monad_State_Class.modify(Halogen_Query_HalogenM.monadStateHalogenM)(function (v2) {
                        var $37 = {};
                        for (var $38 in v2) {
                            if ({}.hasOwnProperty.call(v2, $38)) {
                                $37[$38] = v2[$38];
                            };
                        };
                        $37.loggedIn = true;
                        $37.loading = true;
                        $37.errorBus = new Data_Maybe.Just(v1);
                        return $37;
                    }))(function () {
                        return Control_Bind.discard(Control_Bind.discardUnit)(Halogen_Query_HalogenM.bindHalogenM)(Control_Monad_Aff_Class.liftAff(Halogen_Query_HalogenM.monadAffHalogenM(Control_Monad_Aff_Class.monadAffAff))(Control_Monad_Aff.delay(Data_Int.toNumber(1500))))(function () {
                            return Control_Bind.discard(Control_Bind.discardUnit)(Halogen_Query_HalogenM.bindHalogenM)(Control_Monad_State_Class.modify(Halogen_Query_HalogenM.monadStateHalogenM)(function (v2) {
                                var $40 = {};
                                for (var $41 in v2) {
                                    if ({}.hasOwnProperty.call(v2, $41)) {
                                        $40[$41] = v2[$41];
                                    };
                                };
                                $40.loading = false;
                                return $40;
                            }))(function () {
                                return Control_Bind.discard(Control_Bind.discardUnit)(Halogen_Query_HalogenM.bindHalogenM)(refreshMetamask)(function () {
                                    return Control_Bind.discard(Control_Bind.discardUnit)(Halogen_Query_HalogenM.bindHalogenM)(startCheckInterval(Halogen_Query_HalogenM.applicativeHalogenM)(Halogen_Query_HalogenM.bindHalogenM)(Halogen_Query_HalogenM.monadEffHalogenM(Control_Monad_Aff.monadEffAff))(new Data_Maybe.Just(v1))(5000))(function () {
                                        return Control_Applicative.pure(Halogen_Query_HalogenM.applicativeHalogenM)(v.value0);
                                    });
                                });
                            });
                        });
                    });
                });
            });
        };
        if (v instanceof HandleMsg) {
            if (v.value0 instanceof Types.FIDError) {
                return Control_Bind.discard(Control_Bind.discardUnit)(Halogen_Query_HalogenM.bindHalogenM)(Control_Monad_State_Class.modify(Halogen_Query_HalogenM.monadStateHalogenM)(function (v1) {
                    var $45 = {};
                    for (var $46 in v1) {
                        if ({}.hasOwnProperty.call(v1, $46)) {
                            $45[$46] = v1[$46];
                        };
                    };
                    $45.loggedIn = false;
                    return $45;
                }))(function () {
                    return Control_Applicative.pure(Halogen_Query_HalogenM.applicativeHalogenM)(v.value1);
                });
            };
            if (v.value0 instanceof Types.CheckMetamask) {
                return Control_Bind.bind(Halogen_Query_HalogenM.bindHalogenM)(Data_Functor.map(Halogen_Query_HalogenM.functorHalogenM)(Network_Eth_Metamask.loggedIn)(Control_Monad_Eff_Class.liftEff(Halogen_Query_HalogenM.monadEffHalogenM(Control_Monad_Aff.monadEffAff))(Network_Eth_Metamask.checkStatus)))(function (v1) {
                    return Control_Bind.bind(Halogen_Query_HalogenM.bindHalogenM)(Control_Monad_State_Class.gets(Halogen_Query_HalogenM.monadStateHalogenM)(function (v2) {
                        return v2.loggedIn;
                    }))(function (v2) {
                        return Control_Bind.discard(Control_Bind.discardUnit)(Halogen_Query_HalogenM.bindHalogenM)(checkMetamask(v2)(v1))(function () {
                            return Control_Applicative.pure(Halogen_Query_HalogenM.applicativeHalogenM)(v.value1);
                        });
                    });
                });
            };
            throw new Error("Failed pattern match at Container line 100, column 9 - line 108, column 22: " + [ v.value0.constructor.name ]);
        };
        if (v instanceof RefreshMetamask) {
            return Control_Bind.discard(Control_Bind.discardUnit)(Halogen_Query_HalogenM.bindHalogenM)(refreshMetamask)(function () {
                return Control_Applicative.pure(Halogen_Query_HalogenM.applicativeHalogenM)(v.value0);
            });
        };
        if (v instanceof SetScreen) {
            return Control_Bind.discard(Control_Bind.discardUnit)(Halogen_Query_HalogenM.bindHalogenM)(Control_Monad_State_Class.modify(Halogen_Query_HalogenM.monadStateHalogenM)(function (v1) {
                var $54 = {};
                for (var $55 in v1) {
                    if ({}.hasOwnProperty.call(v1, $55)) {
                        $54[$55] = v1[$55];
                    };
                };
                $54.currentScreen = v.value0;
                return $54;
            }))(function () {
                return Control_Applicative.pure(Halogen_Query_HalogenM.applicativeHalogenM)(v.value1);
            });
        };
        throw new Error("Failed pattern match at Container line 89, column 12 - line 114, column 18: " + [ v.constructor.name ]);
    };
    return Halogen_Component.lifecycleParentComponent(Data_Either.ordEither(Data_Ord.ordUnit)(Data_Ord.ordVoid))({
        initialState: Data_Function["const"](initialState), 
        render: render, 
        "eval": $$eval, 
        receiver: Data_Function["const"](Data_Maybe.Nothing.value), 
        initializer: new Data_Maybe.Just(Halogen_Query.action(Init.create)), 
        finalizer: Data_Maybe.Nothing.value
    });
})();
module.exports = {
    Init: Init, 
    HandleMsg: HandleMsg, 
    RefreshMetamask: RefreshMetamask, 
    SetScreen: SetScreen, 
    checkMetamask: checkMetamask, 
    loadingOverlay: loadingOverlay, 
    promptMetamask: promptMetamask, 
    refreshMetamask: refreshMetamask, 
    startCheckInterval: startCheckInterval, 
    ui: ui
};
